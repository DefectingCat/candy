# Candy Server Configuration Example
# Full configuration with all available options

# Global settings
log_level = "info"    # trace, debug, info, warn, error (default: info)
log_folder = "./logs" # Log files directory (default: ./logs)

# Compression settings (optional, all algorithms enabled by default)
# [compression]
# gzip = true      # Enable gzip compression (default: true)
# deflate = true   # Enable deflate compression (default: true)
# br = true        # Enable brotli compression (default: true)
# zstd = true      # Enable zstd compression (default: true)
# level = 6        # Compression level: 1 (fastest) to 9 (best), default: 6

# Virtual host configuration
# Each [[host]] block defines a separate virtual host

# Example 1: Static file server with SSL
[[host]]
ip = "0.0.0.0"                       # Listen on all interfaces
port = 443                           # HTTPS port
server_name = "example.com"          # Optional domain name for virtual hosting
ssl = true                           # Enable SSL/TLS (default: false)
certificate = "./ssl/server.crt"     # SSL certificate path
certificate_key = "./ssl/server.key" # SSL private key path
timeout = 75                         # HTTP keep-alive timeout in seconds (default: 75)

# Route for static files
[[host.route]]
location = "/" # Route path (must start with /)
root = "./html" # Static files root directory
index = [
    "index.html",
    "index.htm",
] # Default index files (default: ["index.html"])
auto_index = true # Enable directory listing (default: false)
proxy_timeout = 5 # Proxy timeout (only for proxy_pass, default: 5)
max_body_size = 1048576 # Max request body size in bytes (optional)

# Route-level compression settings (optional, override global [compression] settings)
# If any compression field is set for a route, it will use route-specific compression
# instead of global settings. Fields not specified will fall back to global settings.
# gzip = true       # Enable/disable gzip compression for this route (optional)
# deflate = false   # Enable/disable deflate compression for this route (optional)
# br = true         # Enable/disable brotli compression for this route (optional)
# zstd = true       # Enable/disable zstd compression for this route (optional)
# level = 6         # Compression level: 1 (fastest) to 9 (best) (optional)

# Custom error page
[host.route.error_page]
status = 500       # HTTP status code
page = "/500.html" # Path to error page

# Custom 404 page
[host.route.not_found_page]
status = 404       # HTTP status code
page = "/404.html" # Path to 404 page

# Custom response headers
[host.route.headers]
X-Powered-By = "Candy Server"
Cache-Control = "public, max-age=3600"

# Example 2: Reverse proxy
[[host]]
ip = "0.0.0.0"
port = 8080
server_name = "api.example.com"
ssl = false                     # Disable SSL for HTTP

[[host.route]]
location = "/api"
proxy_pass = "http://localhost:3000" # Upstream server URL
proxy_timeout = 10                   # Proxy timeout in seconds (default: 5)
max_body_size = 10485760             # 10MB max body size

# Example 3: HTTP redirect
[[host]]
ip = "0.0.0.0"
port = 80
server_name = "example.com"

[[host.route]]
location = "/old-path"
redirect_to = "https://example.com/new-path" # Target URL
redirect_code = 301                          # Redirect status code (301 = permanent, 302 = temporary)

# Example 4: Lua script handler
[[host]]
ip = "0.0.0.0"
port = 8081

[[host.route]]
location = "/lua"
lua_script = "./scripts/handler.lua" # Path to Lua script
lua_code_cache = true # Enable Lua code caching for performance (default: true)

# Example 4a: Lua script handler with code cache disabled (for debugging)
[[host.route]]
location = "/lua_debug"
lua_script = "./scripts/debug_handler.lua" # Path to debug Lua script
lua_code_cache = false # Disable Lua code caching for debugging purposes

# Example 5: Forward proxy
[[host]]
ip = "0.0.0.0"
port = 8083
server_name = "proxy.example.com"

[[host.route]]
location = "/"
forward_proxy = true                # Enable forward proxy
proxy_timeout = 30                  # Proxy timeout in seconds (default: 5)
max_body_size = 10485760            # 10MB max body size

# Example 6: Multiple routes on same host
[[host]]
ip = "0.0.0.0"
port = 8082

# Static files route
[[host.route]]
location = "/"
root = "./static"
index = ["index.html"]

# API proxy route
[[host.route]]
location = "/api"
proxy_pass = "http://localhost:3001"

# Admin panel redirect
[[host.route]]
location = "/admin"
redirect_to = "https://admin.example.com"
redirect_code = 302

# Example 7: Load balancing with weighted round-robin
[[host]]
ip = "0.0.0.0"
port = 8084
server_name = "loadbalance.example.com"

[[host.route]]
location = "/api"
upstream = "backend_servers" # Reference to upstream server group
proxy_timeout = 30          # Proxy timeout in seconds (default: 5)
max_body_size = 1048576     # 1MB max body size

# Upstream server groups configuration for load balancing
# Multiple upstream groups can be defined
[[upstream]]
name = "backend_servers"    # Upstream group name (referenced in routes)
server = [
    { server = "192.168.1.100:8080", weight = 3 },  # Handles 3x more requests
    { server = "192.168.1.101:8080", weight = 1 },  # Handles normal traffic
    { server = "http://api1.example.com", weight = 2 }, # HTTP scheme is optional
    { server = "https://api2.example.com:443", weight = 1 } # HTTPS with explicit port
]

[[upstream]]
name = "api_servers"
server = [
    { server = "http://api1.example.com", weight = 2 },
    { server = "http://api2.example.com", weight = 3 },
    { server = "http://api3.example.com", weight = 1 }
]

# Example 8: Load balancing with IP hash (session persistence)
[[host]]
ip = "0.0.0.0"
port = 8085
server_name = "session.example.com"

[[host.route]]
location = "/app"
upstream = "session_servers" # Reference to upstream server group with IP hash
proxy_timeout = 30          # Proxy timeout in seconds (default: 5)
max_body_size = 1048576     # 1MB max body size

[[upstream]]
name = "session_servers"
method = "ip_hash"          # Use IP hash load balancing algorithm
server = [
    { server = "192.168.1.102:8080", weight = 1 },
    { server = "192.168.1.103:8080", weight = 1 },
    { server = "192.168.1.104:8080", weight = 1 }
]

# Example 9: Load balancing with Least Connections (least conn) algorithm
[[host]]
ip = "0.0.0.0"
port = 8086
server_name = "leastconn.example.com"

[[host.route]]
location = "/api"
upstream = "leastconn_servers" # Reference to upstream server group with least connections
proxy_timeout = 30          # Proxy timeout in seconds (default: 5)
max_body_size = 1048576     # 1MB max body size

[[upstream]]
name = "leastconn_servers"
method = "least_conn"       # Use least connections load balancing algorithm
server = [
    { server = "192.168.1.105:8080", weight = 1 },  # Server 1: weight 1
    { server = "192.168.1.106:8080", weight = 2 },  # Server 2: weight 2 (handles more connections)
    { server = "192.168.1.107:8080", weight = 1 }   # Server 3: weight 1
]
